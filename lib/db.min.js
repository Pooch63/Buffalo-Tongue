"use strict"
var __extends=this&&this.__extends||function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)}
return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null")
function a(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(a.prototype=n.prototype,new a)}}(),__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}}
Object.defineProperty(exports,"__esModule",{value:!0}),exports.BOOLEAN=exports.STRING=exports.DOUBLE=exports.INT=exports.Database=void 0
var Validation,Schema,Errors,safe_1=__importDefault(require("colors/safe")),KEYWORDS={$validation:"true"},VALIDATION_FUNC_NAME="$validation"
function value_to_string(t){return"boolean"==typeof t?safe_1.default.yellow(t?"true":"false"):"number"==typeof t?safe_1.default.green(t.toString()):"string"==typeof t?safe_1.default.blue('"'.concat(t.replaceAll('"','\\"'),'"')):void 0}function value_type_as_string(t){return Validation.is_int(t)?safe_1.default.green("integer"):Validation.is_double(t)?safe_1.default.green("double"):{string:safe_1.default.blue("string"),boolean:safe_1.default.yellow("boolean")}[typeof t]}!function(t){t.is_int=function(t){return"number"==typeof t&&t==Math.floor(t)},t.is_double=function(t){return"number"==typeof t}}(Validation||(Validation={})),function(t){!function(t){t.INT="integer",t.DOUBLE="double",t.STRING="string",t.BOOLEAN="boolean"}(t.Datatype||(t.Datatype={})),t.validate_type=function(e){var n=e.value
switch(e.type){case t.Datatype.INT:if(!Validation.is_int(n))return!1
break
case t.Datatype.DOUBLE:if(!Validation.is_double(n))return!1
break
case t.Datatype.STRING:if("string"!=typeof n)return!1
break
case t.Datatype.BOOLEAN:if("boolean"!=typeof n)return!1
break
default:return!1}return!0}
var e=function(t){if(this.default=null,this.unique=!1,this.name=t.name,this.type=t.type,null!=t.unique&&(this.unique=t.unique),null!=t.default&&(this.default=t.default),this.validation=t.validation,null!=KEYWORDS[this.name])throw new Error('Column name "'.concat(this.name,'" is invalid -- this word is reserved.'))}
t.Column=e
var n=function(){function e(e){var n=e.rows
this.unique_key=null
for(var a=[],r=0,o=n;r<o.length;r++){var i=o[r]
a.push(new t.Column(i))}for(var u={},s=0,l=a;s<l.length;s++){if(null!=u[(i=l[s]).name])throw new Error('Duplicate row "'.concat(i.name,'"'))
if(i.unique){if(null!=this.unique_key)throw new Error('Table may not have two unique keys. Rows "'.concat(this.unique_key,'" and "').concat(i.name,'" were both declared as unique.'))
this.unique_key=i.name}}this.rows=a}return e.prototype.col_exists=function(t){for(var e=0,n=this.rows;e<n.length;e++){if(n[e].name==t)return!0}return!1},e.prototype.validate=function(e){for(var n,a=0,r=this.rows;a<r.length;a++){var o=r[a],i=null!==(n=e[o.name])&&void 0!==n?n:o.default
if(null==i)throw new Error('Unable to insert record -- row "'.concat(o.name,'" was not included, and no default exists.'))
if(!t.validate_type({value:i,type:o.type}))throw new Error('Column "'.concat(o.name,'" is not of valid type (valid type is of ').concat(o.type,", instead got value ").concat(value_to_string(i)," as ").concat(value_type_as_string(i),")"))}return!0},e}()
t.Table=n,t.get_unique_key=function(t,e){return null==e.unique_key?null:t[e.unique_key]}}(Schema||(Schema={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Error)
t.Nonexistent_Value=e
var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Error)
t.Bad_Type=n
var a=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Error)
t.Nonexistent_Column=a}(Errors||(Errors={}))
var QueryCondition=function(){function t(t){this.conditions=[],this.row_limit=Number.POSITIVE_INFINITY,this.conditions.push(t)}return t.prototype.or=function(t){return this.conditions.push(t),this},t.prototype.limit=function(t){return this.row_limit=t,this},t.prototype.validate_against_condition=function(t){var e=t.row,n=t.condition
if(n.$validation&&!n.$validation(e))return!1
for(var a in n)if(a!=VALIDATION_FUNC_NAME){var r=e[a],o=n[a]
if("function"==typeof o&&!o(r,a))return!1
if("object"!=typeof o)return r==o
if(o.not_eq&&r===o.not_eq)return!1
if(o.eq&&r!==o.eq)return!1
if(o.lt&&!("number"==typeof r&&r<o.lt))return!1
if(o.gt&&!("number"==typeof r&&r>o.gt))return!1
if(o.lte&&!("number"==typeof r&&r<=o.lte))return!1
if(o.gte&&!("number"==typeof r&&r>=o.gte))return!1}return!0},t.prototype.validate=function(e){for(var n=0,a=this.conditions;n<a.length;n++){var r=a[n]
if(r instanceof t){if(!r.validate(e))return!1}else if(!this.validate_against_condition({row:e,condition:r}))return!1}return!0},t}()
function update_row(t,e){for(var n in e){var a=t[n]
null!=a&&(e[n]=a)}}var Table=function(){function t(t){var e=t.name,n=t.schema
this.data={},this.data_count=0,this.name=e,this.schema=n}return t.prototype.insert=function(t){if(!this.schema.validate(t))throw new Error('Record inserted into table "'.concat(this.name,'" did not match schema.'))
for(var e=0,n=this.schema.rows;e<n.length;e++){null==t[(i=n[e]).name]&&(t[i.name]=i.default)}var a=Schema.get_unique_key(t,this.schema)
if(null!=a&&null!=this.data[String(a)])throw new Error('Unique key "'.concat(a,'" has already been inserted.'))
for(var r=0,o=this.schema.rows;r<o.length;r++){var i
if("function"==typeof(i=o[r]).validation&&!i.validation(t[i.name]))throw new Error('Custom validation function declared that column "'.concat(i.name,'" was invalid (value was ').concat(value_to_string(t[i.name]),")"))}this.data[null==a?this.data_count:String(a)]=t,this.data_count+=1},t.prototype.each=function(t){for(var e in this.data){if(null!=this.data[e])if(0==t(this.data[e],e))break}},t.prototype.filter=function(t){if(null!=this.schema.unique_key)for(var e in this.data)null!=this.data[e]&&(t(this.data[e],e)||(this.data[e]=null))
else{for(var n={},a=0,r=0;r<this.data_count;r+=1)t(this.data[r],r)||(n[a]=this.data[r],a+=1)
this.data=n,this.data_count=a}},t}(),Database=function(){function t(){this.tables={}}return t.prototype.get_table=function(t){if(null==this.tables[t])throw new Errors.Nonexistent_Value('Table "'.concat(t,'" does not exist.'))
return this.tables[t]},t.prototype.create_table=function(t,e){var n=new Schema.Table({rows:e.rows})
this.tables[t]=new Table({name:t,schema:n})},t.prototype.create=function(t,e){return this.create_table(t,e)},t.prototype.insert_into_table=function(t,e){t.insert(e)},t.prototype.insert=function(t,e){this.insert_into_table(this.get_table(t),e)},t.prototype.select_from_table=function(t,e){if(null==e){var n=[]
return t.each((function(t){n.push(t)})),n}var a=[]
return t.each((function(t){if(a.length>=e.row_limit)return!1
e.validate(t)&&a.push(t)})),a},t.prototype.select=function(t,e){return this.select_from_table(this.get_table(t),null==e?null:e instanceof QueryCondition?e:new QueryCondition(e))},t.prototype.select_count_from_table=function(t,e){if(null==e)return t.data_count
var n=0
return t.each((function(t){e.validate(t)&&(n+=1)})),n},t.prototype.select_count=function(t,e){return this.select_count_from_table(this.get_table(t),null==e?null:e instanceof QueryCondition?e:new QueryCondition(e))},t.prototype.count=function(t,e){this.select_count(t,e)},t.prototype.select_distinct=function(t,e,n){for(var a="string"==typeof e?[e]:e,r=this.get_table(t),o=0,i=a;o<i.length;o++){var u=i[o]
if(!r.schema.col_exists(u))throw new Errors.Nonexistent_Column('Select distinct requested distinct, nonexistent column "'.concat(u,'"'))}for(var s=null==n?null:n instanceof QueryCondition?n:new QueryCondition(n),l={},c=0,f=r.schema.rows;c<f.length;c++){u=f[c]
l[u.name]={}}var d=[]
return r.each((function(t,e){if(!n||s.validate(t)){for(var r=0,o=a;r<o.length;r++){var i=o[r]
if(null!=l[i][t[i].toString()])return
l[i][t[i].toString()]=t}d.push(t)}})),d},t.prototype.distinct=function(t,e,n){return this.select_distinct(t,e,n)},t.prototype.delete_from_table=function(t,e){t.filter((function(t){return null==e||e.validate(t)}))},t.prototype.delete=function(t,e){this.delete_from_table(this.get_table(t),null==e?null:e instanceof QueryCondition?e:new QueryCondition(e))},t.prototype.update=function(t,e,n){for(var a=this.get_table(t),r=null==n?null:n instanceof QueryCondition?n:new QueryCondition(n),o=0,i=a.schema.rows;o<i.length;o++){var u=i[o]
if(null!=e[u.name]&&!Schema.validate_type({value:e[u.name],type:u.type}))throw new Errors.Bad_Type('Invalid value provided for column in update statement -- "'.concat(u.name,'" is not of valid type (valid type is of ').concat(value_type_as_string(u.type),", instead got value ").concat(value_to_string(e[u.name])," as ").concat(value_type_as_string(e[u.name]),")"))}a.each((function(t){(null==r||r.validate(t))&&update_row(e,t)}))},t}()
exports.Database=Database,exports.INT=Schema.Datatype.INT,exports.DOUBLE=Schema.Datatype.DOUBLE,exports.STRING=Schema.Datatype.STRING,exports.BOOLEAN=Schema.Datatype.BOOLEAN
var db=new Database
db.create_table("users",{rows:[{name:"username",type:exports.STRING},{name:"age",type:exports.INT}]}),db.insert("users",{age:1,username:"Kiyaan"}),db.insert("users",{age:2,username:"Hi!"}),db.insert("users",{age:3,username:"Kiyaan"}),console.log(db.select("users",{$validation:function(t){return"Hi!"==t.username}})),console.log(db.select_distinct("users",["username"])),console.log(db.select("users"))
